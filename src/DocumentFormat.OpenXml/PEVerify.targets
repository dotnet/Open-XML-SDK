<Project>

  <PropertyGroup>
    <!-- .NET Framework builds should pass PEVerify -->
    <RunPeVerify Condition=" '$(RunPeVerify)' == '' ">false</RunPeVerify>
    <CompileWithPeVerify Condition=" '$(CompileWithPeVerify)' == '' ">false</CompileWithPeVerify>
    <PeVerifyPath Condition=" '$(PeVerifyPath)' == '' ">peverify</PeVerifyPath>
  </PropertyGroup>

  <PropertyGroup Condition="$(CompileWithPeVerify)">
    <Features>$(Features);peverify-compat</Features>
  </PropertyGroup>

  <Target Name="Run PEVerify" AfterTargets="Build" Condition="$(CompileWithPeVerify) AND $(RunPeVerify)">
    <ItemGroup>
        <_OutputFileToVerify Include="@(FileWrites)" Condition="'%(Extension)' == '.dll' AND $([System.Text.RegularExpressions.Regex]::IsMatch('%(FullPath)', '.+\\bin\\.+'))" />
    </ItemGroup>
    <Message Text="Running PEVerify" />
    <Exec Command="$(PeVerifyPath) %(_OutputFileToVerify.Identity)" />
  </Target>

</Project>