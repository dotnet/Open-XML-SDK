steps:
  - checkout: none

  - download: current
    artifact: unsigned

  # - task: ExtractFiles@1
  #   inputs:
  #     archiveFilePatterns: '$(Pipeline.Workspace)/unsigned/${{ library.Name }}.*.nupkg'
  #     destinationFolder: '$(Pipeline.Workspace)/raw'
  #   displayName: Extract NuGet Packages

  - powershell: |
      gci unsigned/*.nupkg `
        | % { Expand-Archive -LiteralPath $_ -DestinationPath raw/$(_.Name.Replace('.nupkg', '')) }
    workingDirectory: '$(Pipeline.Workspace)'

  - powershell: |
      gci -r
    workingDirectory: '$(Pipeline.Workspace)'

#   - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
#     displayName: 'OpenXML SDK Assembly ESRP CodeSigning [${{ library.Name }}]'
#     inputs:
#       ConnectedServiceName: 'Open-XML-SDK-ESRP-2021b'
#       FolderPath: '$(Pipeline.Workspace)\$(Version)'
#       Pattern: '**\${{ library.Name }}.dll'
#       UseMinimatch: true
#       signConfigType: inlineSignParams
#       inlineOperation: |
#         [
#           {
#             "keyCode": "CP-230012",
#             "operationSetCode": "SigntoolSign",
#             "parameters": [
#               {
#                 "parameterName": "OpusName",
#                 "parameterValue": "Microsoft"
#               },
#               {
#                 "parameterName": "OpusInfo",
#                 "parameterValue": "http://www.microsoft.com"
#               },
#               {
#                 "parameterName": "PageHash",
#                 "parameterValue": "/NPH"
#               },
#               {
#                 "parameterName": "FileDigest",
#                 "parameterValue": "/fd sha256"
#               },
#               {
#                 "parameterName": "TimeStamp",
#                 "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
#               }
#             ],
#             "toolName": "signtool.exe",
#             "toolVersion": "6.2.9304.0"
#           }
#         ]

#   - task: ArchiveFiles@2
#     inputs:
#       rootFolderOrFile: '$(Pipeline.Workspace)/$(Version)' 
#       includeRootFolder: false
#       archiveType: 'zip'
#       archiveFile: '$(Build.ArtifactStagingDirectory)/${{ library.Name }}.$(Version).nupkg' 
#       replaceExistingArchive: true 
#       verbose: true
#     displayName: Creating archive for ${{ library.Name }}

#   - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
#     displayName: 'OpenXML SDK Nuget Pkg ESRP CodeSigning [${{ library.Name }}]'
#     inputs:
#       ConnectedServiceName: 'Open-XML-SDK-ESRP-2021b'
#       FolderPath: '$(Build.ArtifactStagingDirectory)'
#       Pattern: '*.nupkg'
#       signConfigType: inlineSignParams
#       inlineOperation: |
#         [
#             {
#                 "keyCode": "CP-401405",
#                 "operationSetCode": "NuGetSign",
#                 "parameters": [ ],
#                 "toolName": "sign",
#                 "toolVersion": "1.0"
#             },
#             {
#                 "keyCode": "CP-401405",
#                 "operationSetCode": "NuGetVerify",
#                 "parameters": [ ],
#                 "toolName": "sign",
#                 "toolVersion": "1.0"
#             }
#         ]

# - task: CopyFiles@2
#   inputs:
#     sourceFolder: '$(Pipeline.Workspace)/unsigned'
#     contents: '*.snupkg'
#     targetFolder: '$(Build.ArtifactStagingDirectory)'

# - task: PublishBuildArtifacts@1
#   displayName: 'Publish Signed'
#   inputs:
#     PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#     artifactName: 'signed'
